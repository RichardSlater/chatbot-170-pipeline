language: none

resources:

  - name: chatbot-170-infrastructure_master
    type: gitRepo
    integration: github
    versionTemplate:
      sourceName: RichardSlater/chatbot-170-infrastructure
      branch: master

  - name: azure_cli_configuration
    type: cliConfig
    integration: Azure (Chatbot Experiments)

  - name: scheduled_deprovisioning
    type: time
    versionTemplate:
      interval: "30 22 * * *"

jobs:
  - name: provisioning
    type: runSh
    steps:
      - IN: azure_cli_configuration
      - IN: chatbot-170-infrastructure_master
      - TASK:
        - script: chmod +x $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/*.sh
        - script: $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/ensure-terraform.sh 0.11.5
        - script: . $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/export-azure-environment.sh
        - script: $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/execute-terraform.sh apply

  - name: deprovisioning
    type: runSh
    steps:
      - IN: azure_cli_configuration
      - IN: scheduled_deprovisioning
      - IN: chatbot-170-infrastructure_master
        switch: off
      - IN: provisioning
        switch: off
      - TASK:
        - script: chmod +x $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/*.sh
        - script: $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/ensure-terraform.sh 0.11.5
        - script: . $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/export-azure-environment.sh
        - script: $CHATBOT170INFRASTRUCTURE_MASTER_STATE/scripts/execute-terraform.sh destroy
